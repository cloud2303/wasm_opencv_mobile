<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<script src="./cmake-build-release-wasm/wasm_test.js"></script>
<script type="module">
    let module = await createModule()
    // console.log(module.add(1,5))
    // console.log(module.cwrap('add', 'number', ['number', 'number'])(1, 5))
    // const api = {
    //     processData: module.cwrap('process_data', null, ['number', 'number', 'number', 'number']),
    //     processQrcode: module.cwrap('process_Qrcode', null, ['number', 'number', 'number', 'number']),
    //
    // };
    console.log(module)

    async function loadImage(src) {
        // Load image
        const imgBlob = await fetch(src).then((resp) => resp.blob());
        const img = await createImageBitmap(imgBlob);
        // Make canvas same size as image
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;
        // Draw image onto canvas

        const ctx = canvas.getContext('2d', {willReadFrequently: true});
        ctx.drawImage(img, 0, 0);
        return ctx.getImageData(0, 0, img.width, img.height);
    }


    const input = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    input.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const img = new Image();
        img.onload = async function () {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            // 获取图像像素数据（RGBA）
            const imageData = ctx.getImageData(0, 0, img.width, img.height);
            const pixelData = imageData.data;
            const dataSize = pixelData.length;
            console.log(pixelData)

            console.log("需要分配的图片大小(mb)1", dataSize / (1024 * 1024))
            try {
                // 拷贝数据到 wasm 内存
                let t1 = performance.now()
                let res = module.process_Qrcode(pixelData, img.width, img.height);
                let t2 = performance.now() - t1
                console.log(res)
                console.log(t2, "二维码识别时间")
            } catch (err) {
                console.error(err);
                alert("处理出错: " + err.message);
            }
        };
        img.src = URL.createObjectURL(file);
    });


</script>
<body>
<h2>选择图片进行灰度处理</h2>
<input type="file" id="fileInput" accept="image/*"/>
<br/><br/>
<canvas id="canvas"></canvas>
</body>
</html>